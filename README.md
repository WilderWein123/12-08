# Домашнее задание к занятию «Резервное копирование баз данных»

**Домашнее задание выполните в Google Docs или в md-файле в вашем репозитории GitHub.** 

Для оформления вашего решения в GitHub можете воспользоваться [шаблоном](https://github.com/netology-code/sys-pattern-homework).

Название файла должно содержать номер лекции и фамилию студента. Пример названия: «12.8. Резервное копирование баз данных — Александр Александров».

Перед тем как выслать ссылку, убедитесь, что её содержимое не является приватным, то есть открыто на просмотр всем, у кого есть ссылка. Если необходимо прикрепить дополнительные ссылки, просто добавьте их в свой Google Docs.

Любые вопросы по решению задач задавайте в чате учебной группы.

---

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*


1.1 

*Конец недели (вс) - полный бекап, ежедневный дифф, в зависимости от количества изменений в БД. При наличии огромного количества изменений в существующих данных на выходе можно получить диффы, которые будут больше оригниальной базы*

*Либо конец недели (вс) - полный бекап, ежедневный инкремент. В случае огромных ежедневных изменений в целом ситуация будет постабильнее*

1.2

*Если поломка прям прогнозируется (например разработчик лезет в бд, и не уверен, что все пройдет "гладко", то перед предполагаемой поломкой сделать полный бекап вручную.*

1.3

*Тут достаточно размывчатая ситуация. Пожалуй можно выделить три случая*

*1) Если мы рассматриваем случай, когда у нас на сервере только одна БД и поломка имеет физический характер (отказ сервера, носителя и тд), то в этом случае нам поможет репликация (не важно мастер-слейв, или мастер-мастер).*
*2) Если мы рассматриваем случай порчи БД от неверного запроса, то тут реплицированные копии нам не помогут. Невозможно. По крайней мере, штатными средствами. Только восстанаовление из бекапа. *
*3) Если на сервере несколько БД, и сломана только одна, а остальные работают - то тоже невозможно. Делать DROP сломанной БД и восстанавливать ее из бекапа.*

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

```
pg_dump -h SERVER -p PORT -U postgres databasename > /path/ot/backup/databasename.sql
```

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

*бекап:*
```
DBLIST=$(psql -U postgres -c "select datname from pg_database"  2>/dev/null | grep -v '\-\-\-\-\-' | grep -v 'datname' | grep -v 'rows')
for i in $DBLIST; do
	pg_dump -h SERVER -p PORT -U postgres $i > /path/ot/backup/$i.sql
done
```

*ресторимм бекап практически аналогично*

```
DB=databasename
cat /path/ot/backup/$DB.sql | psql -U postgres $DB
```
*если восстанавливаем весь сервер целиком, то делаем обвязку с циклом на баше как и в первом случае*

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

```
#делаем полный бекап
mysqlbackup --user=root --password --port=3306 --with-timestamp --backup-dir=/path/to/backup databasename
#делаем инкрементальный
mysqlbackup --user=root --password --port=3306 --with-timestamp --incremental --backup-dir=/path/to/backup databasename
```
*однако как я понял на данный момент утилита доступена только для Enterprise (платной) версии mysql*
*Беглый гуглёж показал что в стандартном репозитории ОС есть тулза, способная делать автоматические в т.ч. инкрементальные бекапы - automysqlbackup*

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

*использование реплики будет давать преимущество в сравнении с обычным бекапом в случае порчи оборудования либо потери канала связи (допустим, если слейв-сервер стоит за другим маршрутизатором)*

---

Задания, помеченные звёздочкой, — дополнительные, то есть не обязательные к выполнению, и никак не повлияют на получение вами зачёта по этому домашнему заданию. Вы можете их выполнить, если хотите глубже шире разобраться в материале.
